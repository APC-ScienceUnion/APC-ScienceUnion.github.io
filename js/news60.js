document.addEventListener("DOMContentLoaded",()=>{const m=document.querySelectorAll("[data-news60]");if(m.length===0)return;const t="https://60s-api.viki.moe/v2/60s?encoding=text";fetch(t).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.text()}).then(t=>{const e=t.split("\n").filter(t=>t.trim()!=="");if(e.length===0){throw new Error("API返回空内容")}let o="";o+=`<h2>${e[0]}</h2>`;if(e.length>2){o+="<ol>";for(let t=1;t<e.length-1;t++){const r=e[t].replace(/^\d+\.\s*/,"");o+=`<li style="margin-bottom: 8px; position: relative; padding-left: 15px;">
              ${r}
            </li>`}o+="</ol>"}if(e.length>1){o+=`<div style="margin-top: 15px; font-style: italic;">${e[e.length-1]}</div>`}const c=["星期日","星期一","星期二","星期三","星期四","星期五","星期六"];const n=function t(e){const o=e.join(" ");let n,a,s;let r=o.match(/(20\d{2})[-\/.](\d{1,2})[-\/.](\d{1,2})/);if(r){n=parseInt(r[1],10);a=parseInt(r[2],10);s=parseInt(r[3],10)}else{const i=o.match(/(20\d{2})年(\d{1,2})月(\d{1,2})日/);if(i){n=parseInt(i[1],10);a=parseInt(i[2],10);s=parseInt(i[3],10)}}const l=n&&a&&s?new Date(n,a-1,s):new Date;return{y:n||l.getFullYear(),m:a||l.getMonth()+1,d:s||l.getDate(),week:c[l.getDay()]}}(e);const a=n.y,s=n.m,l=n.d;const i=`${a}年${s}月${l}日`;const f=n.week;const d="今日简报";const h=[];for(let t=1;t<e.length-1;t++){h.push(e[t].replace(/^\d+\.\s*/,"").trim())}m.forEach(r=>{r.innerHTML=o;const t=r.getAttribute("data-news60-header")||"";generateNewsPoster({headerUrl:t,dateText:i,weekText:f,titleText:d,items:h,footer:"图像制作：格物社 / A.P.C.科学联盟",year:a,month:s,day:l}).then(({dataUrl:t,fileName:e,canvas:o})=>{const n=document.createElement("div");n.style.marginTop="18px";let a;if(t){const s=document.createElement("img");s.src=t;s.alt="今日简报 长图";a=s}else{a=o}a.style.width="100%";a.style.borderRadius="8px";a.style.boxShadow="0 6px 24px rgba(0,0,0,.08)";n.appendChild(a);r.appendChild(n)}).catch(()=>{})})}).catch(e=>{m.forEach(t=>{t.innerHTML=`<div style="color: #d9534f; padding: 15px; background: #f8d7da; border-left: 4px solid #d9534f;">
            加载60秒新闻失败: ${e.message}
          </div>`})})});function generateNewsPoster({headerUrl:N="",dateText:P,weekText:H,titleText:L,items:Y,footer:D,year:R,month:A,day:B}){return new Promise(async(e,o)=>{try{const c=1080;const r=72;const f=Math.round(c*.5);const l=document.createElement("canvas");l.width=c;l.height=10;const i=l.getContext("2d");const d={date:'500 36px "Noto Sans SC","Microsoft YaHei",sans-serif',week:'400 32px "Noto Sans SC","Microsoft YaHei",sans-serif',titleEn:'600 26px "Noto Sans SC","Microsoft YaHei",sans-serif',title:'700 64px "Noto Sans SC","Microsoft YaHei",sans-serif',item:'400 36px "Noto Sans SC","Microsoft YaHei",sans-serif',footer:'400 26px "Noto Sans SC","Microsoft YaHei",sans-serif',dayBadge:'800 200px "Noto Sans SC","Microsoft YaHei",sans-serif'};const h=c-r*2;function s(e,t,o){const n=t.split("");let a="";const s=[];for(let t=0;t<n.length;t++){const r=a+n[t];const l=e.measureText(r).width;if(l>o&&a){s.push(a);a=n[t]}else{a=r}}if(a)s.push(a);return s}i.font=d.item;const m=64;let a=0;const g=Y.map((t,e)=>{const o=`${e+1}. `;const n=s(i,o+t,h);a+=n.length*m+24;return n});const p=64+26+36+24+32;const x=120;const y=f+40+p+24+a+x;const u=document.createElement("canvas");u.width=c;u.height=y;const S=u.getContext("2d");S.fillStyle="#ffffff";S.fillRect(0,0,c,y);const w=document.createElement("canvas");w.width=c;w.height=f;const T=w.getContext("2d");const C=async()=>{if(!N){const e=T.createLinearGradient(0,0,c,f);e.addColorStop(0,"#f8d77a");e.addColorStop(1,"#f3a34e");T.fillStyle=e;T.fillRect(0,0,c,f);return}try{const t=await loadImage(N);const o=t.width,n=t.height;const a=Math.max(c/o,f/n);const s=o*a,r=n*a;const l=(c-s)/2;const i=(f-r)/2;T.drawImage(t,l,i,s,r)}catch(t){const e=T.createLinearGradient(0,0,c,f);e.addColorStop(0,"#f8d77a");e.addColorStop(1,"#f3a34e");T.fillStyle=e;T.fillRect(0,0,c,f)}};await C();const v=Math.max(0,f-18);S.drawImage(w,0,0,c,v,0,0,c,v);const M=S.createLinearGradient(0,v-18,0,v);M.addColorStop(0,"rgba(255,255,255,0)");M.addColorStop(1,"#ffffff");S.fillStyle=M;S.fillRect(0,v-18,c,18);let n=f+40;const E=B<10?"0"+B:""+B;S.font=d.dayBadge;const k=S.measureText(E);const I=k.actualBoundingBoxDescent||0;const $=Math.max(0,v-12-I);S.save();S.shadowColor="rgba(0,0,0,.25)";S.shadowBlur=12;S.fillStyle="#ffffff";S.fillText(E,r,$);S.restore();S.fillStyle="#222222";S.font=d.title;S.fillText(L,r,n);n+=64;S.fillStyle="#666666";S.font=d.date;S.fillText(P,r,n);n+=42;S.font=d.week;S.fillText(H,r,n);n+=40;S.strokeStyle="#eeeeee";S.lineWidth=2;S.beginPath();S.moveTo(r,n);S.lineTo(c-r,n);S.stroke();n+=48;S.fillStyle="#333333";S.font=d.item;g.forEach((t,e)=>{const o=m;t.forEach(t=>{S.fillText(t,r,n);n+=o});n+=24});n+=8;S.strokeStyle="#eeeeee";S.beginPath();S.moveTo(r,n);S.lineTo(c-r,n);S.stroke();n+=36;S.fillStyle="#8a8a8a";S.font=d.footer;S.fillText(D,r,n);n+=34;S.fillText("头图供图：SORTZE",r,n);n+=34;S.fillText("特别鸣谢：daily60s API",r,n);const b=`news60_${R}-${A}-${B}.png`;let t="";try{t=u.toDataURL("image/png")}catch(t){}e({dataUrl:t,fileName:b,canvas:u})}catch(t){o(t)}})}function loadImage(n){return new Promise((t,e)=>{const o=new Image;o.crossOrigin="anonymous";o.referrerPolicy="no-referrer";o.onload=()=>t(o);o.onerror=e;o.src=n})}